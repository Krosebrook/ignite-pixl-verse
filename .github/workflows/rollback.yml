name: Production Rollback

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target version/SHA to rollback to'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      rollback_database:
        description: 'Rollback database migrations'
        required: true
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  validate-rollback:
    name: Validate Rollback Target
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate target version exists
        run: |
          if ! git rev-parse ${{ inputs.target_version }} >/dev/null 2>&1; then
            echo "‚ùå Target version ${{ inputs.target_version }} does not exist"
            exit 1
          fi
          echo "‚úÖ Target version validated: ${{ inputs.target_version }}"
      
      - name: Check version is older than current
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          TARGET_SHA=$(git rev-parse ${{ inputs.target_version }})
          
          if [ "$CURRENT_SHA" == "$TARGET_SHA" ]; then
            echo "‚ùå Target is the same as current deployment"
            exit 1
          fi
          
          if ! git merge-base --is-ancestor $TARGET_SHA $CURRENT_SHA; then
            echo "‚ö†Ô∏è  Warning: Target is not an ancestor of current version"
          fi
      
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ROLLBACK] Production rollback to ${{ inputs.target_version }}`,
              body: `## Production Rollback Initiated
              
              **Target Version**: \`${{ inputs.target_version }}\`
              **Reason**: ${{ inputs.reason }}
              **Database Rollback**: ${{ inputs.rollback_database }}
              **Initiated By**: @${{ github.actor }}
              **Time**: ${new Date().toISOString()}
              
              ## Rollback Steps
              - [ ] Code deployment rolled back
              - [ ] Database migrations rolled back (if applicable)
              - [ ] Smoke tests passed
              - [ ] Monitoring alerts cleared
              
              ## Post-Rollback Actions
              - [ ] Root cause analysis completed
              - [ ] Fix deployed
              - [ ] Incident postmortem created
              `,
              labels: ['incident', 'rollback', 'production']
            });
            
            console.log(`Created rollback issue: ${issue.data.html_url}`);

  rollback-database:
    name: Rollback Database
    runs-on: ubuntu-latest
    needs: [validate-rollback]
    if: inputs.rollback_database == true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run rollback script
        run: |
          chmod +x scripts/rollback.sh
          ./scripts/rollback.sh --database --target=${{ inputs.target_version }}
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      
      - name: Verify database state
        run: |
          echo "Verifying database integrity..."
          # Run basic health checks
          npm run db:healthcheck

  rollback-deployment:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-database]
    if: always() && (needs.rollback-database.result == 'success' || needs.rollback-database.result == 'skipped')
    environment:
      name: production-rollback
      url: https://flashfusion.lovable.app
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build target version
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
      
      - name: Deploy rollback version
        run: |
          echo "Deploying version ${{ inputs.target_version }}"
          # Lovable platform handles deployment
          # In other platforms, this would trigger the deployment
      
      - name: Create Sentry release for rollback
        uses: getsentry/action-release@v1
        if: env.SENTRY_AUTH_TOKEN != ''
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ inputs.target_version }}
          finalize: true

  post-rollback-verification:
    name: Post-Rollback Verification
    runs-on: ubuntu-latest
    needs: [rollback-deployment]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Run smoke tests
        run: npm run test:smoke
      
      - name: Check error rates
        run: |
          echo "Monitoring error rates for 5 minutes..."
          # In production, query Sentry/Datadog for error spike
          # For now, basic health check
          for i in {1..5}; do
            curl -f https://flashfusion.lovable.app/health || exit 1
            sleep 60
          done
      
      - name: Notify team
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: |
            üîÑ Production Rollback ${{ job.status }}
            
            **Target**: ${{ inputs.target_version }}
            **Reason**: ${{ inputs.reason }}
            **Database Rolled Back**: ${{ inputs.rollback_database }}
            **By**: @${{ github.actor }}
            
            ${{ job.status == 'success' && '‚úÖ Smoke tests passed' || '‚ùå Post-rollback verification failed' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback-failure:
    name: Rollback Failed - Alert
    runs-on: ubuntu-latest
    needs: [rollback-deployment, post-rollback-verification]
    if: failure()
    steps:
      - name: Alert on rollback failure
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          text: |
            üö® CRITICAL: Production Rollback FAILED
            
            **Target**: ${{ inputs.target_version }}
            **Reason**: ${{ inputs.reason }}
            
            ‚ö†Ô∏è  Manual intervention required immediately!
            Check GitHub Actions logs and contact DevOps on-call.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Create high-priority incident
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® CRITICAL: Rollback to ${{ inputs.target_version }} FAILED`,
              body: `## Critical Production Issue
              
              Rollback attempt has FAILED. Production may be in an inconsistent state.
              
              **Target Version**: \`${{ inputs.target_version }}\`
              **Original Issue**: ${{ inputs.reason }}
              
              ## Immediate Actions Required
              1. Check GitHub Actions logs: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              2. Verify production health
              3. Consider manual rollback or forward fix
              4. Escalate to on-call engineer
              
              @oncall-devops @tech-lead
              `,
              labels: ['critical', 'incident', 'rollback-failed', 'production'],
              assignees: ['oncall-devops']
            });
